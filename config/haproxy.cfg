# HAProxy Configuration for AI-SWARM-MIAMI-2025
# Implements mTLS for internal services and RBAC via ACLs

global
    log stdout local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /dev/null
    errorfile 403 /dev/null
    errorfile 408 /dev/null
    errorfile 500 /dev/null
    errorfile 502 /dev/null
    errorfile 503 /dev/null
    errorfile 504 /dev/null

# Frontend for external access (HTTPS with mTLS optional)
frontend fe_main
    bind *:443 ssl crt /etc/ssl/certs/server.pem alpn h2,http/1.1
    # mTLS for admin paths
    acl is_admin path_beg /admin
    acl client_cert req.ssl_verify_result -m int 0
    http-request deny if is_admin !client_cert
    default_backend be_litellm

# Backend for LiteLLM (internal, mTLS enforced)
backend be_litellm
    mode http
    balance roundrobin
    server litellm litellm:4000 check ssl verify none
    # RBAC ACL example: Deny non-admin to sensitive endpoints
    acl is_sensitive path_beg /v1/models/admin
    http-request deny if is_sensitive !{ hdr_admin -m found }

# Frontend for stats (protected)
frontend fe_stats
    bind *:8888
    acl is_stats path /stats
    use_backend be_stats if is_stats

backend be_stats
    mode http
    server stats1 127.0.0.1:8404 check

# TLS Configuration
ssl-default-bind-ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256
ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
tune.ssl.default-dh-param 2048

# Client Certificate for mTLS
ssl crt /etc/ssl/certs/client-ca.pem ca-file /etc/ssl/certs/ca.pem crt-ignore-err all