# Railway Pro Cloud Services - Overflow and High-Availability
# Deploy to Railway Cloud (32GB RAM / 32 vCPU available)
# $20/month includes all usage - perfect for burst capacity

version: '3.8'

services:
  # Railway Service 1: Backup vLLM Inference (High Availability)
  railway-vllm-backup:
    image: vllm/vllm-openai:latest
    container_name: railway-vllm-backup
    restart: always
    environment:
      # Railway auto-injects PORT env var
      PORT: 8000
      CUDA_VISIBLE_DEVICES: ""  # CPU mode on Railway (no GPU)
      VLLM_WORKER_MULTIPROC_METHOD: spawn
      VLLM_CPU_MODE: 1  # Enable CPU inference
      VLLM_ENGINE_ITERATION_TIMEOUT_S: 3600
      VLLM_LOG_LEVEL: INFO
      RAILWAY_SERVICE_NAME: vllm-backup
    command: [
      "--model", "microsoft/Phi-3-mini-4k-instruct",  # Smaller model for CPU
      "--served-model-name", "phi-3-mini",
      "--host", "0.0.0.0",
      "--port", "${PORT:-8000}",
      "--dtype", "float32",  # CPU compatible
      "--max-model-len", "4096",
      "--tensor-parallel-size", "1",
      "--device", "cpu"
    ]
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: '16'
    labels:
      railway.app/service: vllm-backup
      railway.app/healthcheck-path: /health
      railway.app/healthcheck-timeout: 30

  #Railway Service 2: Additional LiteLLM Gateway (Load Balancing)
  railway-litellm-lb:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: railway-litellm-lb
    restart: always
    environment:
      PORT: 4000
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      DATABASE_URL: postgresql://litellm:${POSTGRES_PASSWORD}@postgres-standby:5432/litellm?replica=true  # Read replica
      PRIMARY_DB_URL: postgresql://litellm:${POSTGRES_PASSWORD}@oracle-postgres.railway.internal:5432/litellm  # For writes
      REDIS_URL: sentinel://default:redis_master_pass_2025@redis-sentinel-railway:26379/0?sentinel=yes&sentinel_master=aiswarm-master
      STORE_MODEL_IN_DB: true
      LITELLM_MODE: PRODUCTION
      #Railway specific
      RAILWAY_SERVICE_NAME: litellm-lb
      # Model endpoints
      STARLORD_VLLM_URL: http://100.72.73.3:8000/v1
      THANOS_BACKUP_URL: http://100.122.12.54:8002/v1
      RAILWAY_VLLM_URL: http://railway-vllm-backup.railway.internal:8000/v1
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4'
    labels:
      railway.app/service: litellm-lb
      railway.app/healthcheck-path: /health
      railway.app/domains: ai-swarm-gateway.up.railway.app
    depends_on:
      - redis-slave
      - redis-sentinel-railway
      - postgres-standby

  #Railway Service 3: Redis Slave and Sentinel for HA
  redis-slave:
    image: redis:7-alpine
    container_name: railway-redis-slave
    restart: always
    command: redis-server /etc/redis/redis.conf
    volumes:
      - railway-redis-data:/data
      - ./config/redis-slave.conf:/etc/redis/redis.conf
    environment:
      ORACLE_REDIS_IP: ${ORACLE_REDIS_IP}  # External IP of Oracle Redis
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'
    labels:
      railway.app/service: redis-slave
      railway.app/volume: railway-redis-data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis_master_pass_2025", "info replication | grep role"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis-sentinel-railway:
    image: redis:7-alpine
    container_name: railway-redis-sentinel
    restart: always
    command: redis-sentinel /etc/redis/sentinel.conf
    volumes:
      - ./config/sentinel.conf:/etc/redis/sentinel.conf
    environment:
      ORACLE_REDIS_IP: ${ORACLE_REDIS_IP}
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
    labels:
      railway.app/service: redis-sentinel
    healthcheck:
      test: ["CMD", "redis-cli", "--sentinel", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis-slave

  redis-exporter-railway:
    image: prometheuscommunity/redis-exporter:latest
    container_name: railway-redis-exporter
    restart: always
    environment:
      REDIS_ADDR: "redis-slave:6379"
      REDIS_PASSWORD: "redis_master_pass_2025"
    ports:
      - "9121:9121"
    labels:
      railway.app/service: redis-exporter
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis-slave

  redis-exporter-railway:
    image: prometheuscommunity/redis-exporter:latest
    container_name: railway-redis-exporter
    restart: always
    environment:
      REDIS_ADDR: "redis-slave:6379"
      REDIS_PASSWORD: "redis_master_pass_2025"
    ports:
      - "9121:9121"
    labels:
      railway.app/service: redis-exporter
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis-slave

  redis-exporter-railway:
    image: prometheuscommunity/redis-exporter:latest
    container_name: railway-redis-exporter
    restart: always
    environment:
      REDIS_ADDR: "redis-slave:6379"
      REDIS_PASSWORD: "redis_master_pass_2025"
    ports:
      - "9121:9121"
    labels:
      railway.app/service: redis-exporter
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis-slave

  redis-exporter-railway:
    image: prometheuscommunity/redis-exporter:latest
    container_name: railway-redis-exporter
    restart: always
    environment:
      REDIS_ADDR: "redis-slave:6379"
      REDIS_PASSWORD: "redis_master_pass_2025"
    ports:
      - "9121:9121"
    labels:
      railway.app/service: redis-exporter
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis-slave

  #Railway Service 4: Web Scraping & Research Worker
  railway-research-worker:
    build:
      context: ../services/research-worker
      dockerfile: Dockerfile
    container_name: railway-research-worker
    restart: always
    environment:
      PORT: 8002
      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      BRAVE_API_KEY: ${BRAVE_API_KEY}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY}
      # Research config
      MAX_WORKERS: 8
      MAX_SEARCH_RESULTS: 20
      ENABLE_CACHING: true
      CACHE_TTL: 3600
      #Railway specific
      RAILWAY_SERVICE_NAME: research-worker
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '8'
    labels:
      railway.app/service: research-worker
      railway.app/healthcheck-path: /health
      railway.app/domains: research.ai-swarm.up.railway.app

  #Railway Service 5: Cost Analytics Dashboard
  railway-analytics:
    image: grafana/grafana:latest
    container_name: railway-analytics
    restart: always
    environment:
      PORT: 3000
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_INSTALL_PLUGINS: redis-datasource,prometheus
      GF_SERVER_ROOT_URL: https://analytics.ai-swarm.up.railway.app
      RAILWAY_SERVICE_NAME: analytics
    volumes:
      - railway-grafana-data:/var/lib/grafana
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    labels:
      railway.app/service: analytics
      railway.app/domains: analytics.ai-swarm.up.railway.app
      railway.app/volume: railway-grafana-data

  # PostgreSQL Standby for HA Replication from Oracle Primary
  postgres-standby:
    image: postgres:15-alpine
    container_name: railway-postgres-standby
    restart: always
    environment:
      POSTGRES_DB: litellm
      POSTGRES_USER: litellm
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PRIMARY_CONNINFO: "host=oracle-postgres.railway.internal port=5432 user=replicator password=rep_secure_pass_2025 dbname=litellm application_name=railway_standby"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - railway-postgres-standby-data:/var/lib/postgresql/data
      - ./config/postgresql-arm64.conf:/var/lib/postgresql/data/postgresql.conf
      - ./config/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf
    command: >
      postgres
      -c config_file=/var/lib/postgresql/data/postgresql.conf
      -c hba_file=/var/lib/postgresql/data/pg_hba.conf
      -c primary_conninfo='${PRIMARY_CONNINFO}'
      -c recovery_target_timeline='latest'
      -c hot_standby=on
    labels:
      railway.app/service: postgres-standby
      railway.app/volume: railway-postgres-standby-data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U litellm -d litellm && psql -U litellm -d litellm -c 'SELECT pg_is_in_recovery();' | grep -q 't'"]
      interval: 30s
      timeout: 10s
      retries: 5
    depends_on:
      - railway-litellm-lb  # Ensure primary access via network

volumes:
  railway-redis-data:
    driver: local
  railway-grafana-data:
    driver: local
  railway-postgres-standby-data:
    driver: local

#Railway Deployment Notes:
# 1. Each service gets its own Railway service for independent scaling
# 2. Railway provides automatic HTTPS endpoints
# 3. Internal networking via *.railway.internal domains
# 4. Auto-scaling based on CPU/memory usage
# 5. Zero-downtime deployments with health checks
# 6. Persistent volumes for data retention

# Cost Optimization:
# - Pro plan includes $20/month of usage
# - With 32GB RAM and 32 vCPU available
# - Perfect for burst capacity and overflow
# - Automatic sleep when not in use saves credits